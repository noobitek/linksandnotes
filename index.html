<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لینک‌های مفید من</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome CDN for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap');
        body {
            background: linear-gradient(to bottom right, #1e293b, #2d3748);
            min-height: 100vh;
            font-family: 'Vazirmatn', sans-serif;
            color: #e2e8f0;
        }
        .link-card {
            background: #2d3748;
            border: 1px solid #4b5563;
            transition: transform 0.3s ease, box-shadow 0.3s ease, background 0.3s ease;
            cursor: pointer; /* Add cursor pointer to indicate clickability */
            position: relative; /* Added for absolute positioning of icons */
            padding-top: 20px; /* Reduced padding-top */
            padding-left: 40px; /* Keep original padding-left */
            padding-right: 24px; /* Keep original padding-right */
            padding-bottom: 12px; /* Reduced padding-bottom */
        }
        .link-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
            background: #3b4a6b;
        }
        .form-container {
            background: #2d3748;
            border: 1px solid #4b5563;
            transition: box-shadow 0.3s ease;
        }
        .form-container:hover {
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }
        input, select, textarea {
            background: #1e293b;
            border: 1px solid #4b5563;
            color: #e2e8f0;
        }
        input:focus, select:focus, textarea:focus {
            border-color: #6366f1;
            outline: none;
            ring: 2px #6366f1;
        }
        button {
            transition: background 0.3s ease;
        }
        button:hover {
            background: #4f46e5;
        }
        .delete-btn {
            transition: color 0.3s ease;
            font-size: 1.5rem; /* Made delete icon bigger */
        }
        .delete-btn:hover {
            color: #ef4444;
        }
        .notes-text {
            color: #94a3b8;
            word-break: break-word;
            overflow-wrap: break-word;
            max-height: 60px; /* Fixed height for notes within the card */
        }
        /* New class for scrollable notes */
        .notes-text.scrollable {
            overflow-y: auto;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 50;
            align-items: center;
            justify-content: center;
        }
        .modal.show {
            display: flex;
        }
        /* Style for the notes display in the popup */
        .notes-display {
            white-space: pre-wrap; /* Preserves whitespace and line breaks */
            max-height: 400px; /* Increased height for long notes */
            overflow-y: auto; /* Add scroll if notes are too long */
            padding: 10px;
            background: #1e293b;
            border-radius: 8px;
            color: #e2e8f0;
        }

        /* Specific styling for the notes modal container to make it larger */
        #notes-modal .form-container {
            max-width: 600px; /* Increased max-width for the notes modal */
            width: 90%; /* Ensure it's responsive */
        }
        .icon-group {
            position: absolute; /* Position icons absolutely */
            top: 0px; /* Moved closer to top */
            left: 10px; /* Distance from left */
            z-index: 10; /* Ensure icons are above other content */
            display: flex;
            flex-direction: column; /* Stack icons vertically */
            align-items: flex-start; /* Align icons to the start (left) */
            gap: 5px; /* Adjust space between delete and edit icons */
        }
        .edit-icon {
            cursor: pointer;
            color: #94a3b8; /* Default color for edit icon */
            transition: color 0.3s ease;
        }
        .edit-icon:hover {
            color: #6366f1; /* Hover color for edit icon */
        }
        /* Style for containing long titles */
        .link-card h3 {
            word-break: break-word;
            overflow-wrap: break-word;
            overflow: hidden; /* Hide overflowing text */
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center p-6">
    <div class="text-center mb-10">
        <h1 class="text-4xl font-bold text-white">لینک‌های مفید من</h1>
        <p class="text-lg text-gray-300 mt-2">مجموعه‌ای از منابع مورد علاقه من</p>
        <p id="user-id-display" class="text-sm text-gray-400 mt-2">Loading user ID...</p>
    </div>
    <div class="max-w-md w-full mb-6 flex gap-2">
        <input id="search-input" type="text" placeholder="جستجوی لینک‌ها..." class="flex-1 p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 text-right bg-[#1e293b] border-[#4b5563]">
        <button id="search-btn" class="bg-indigo-600 text-white p-2 rounded-md hover:bg-indigo-700">جستجو</button>
    </div>
    <div class="max-w-md w-full mb-6">
        <button id="show-form-btn" class="w-full bg-indigo-600 text-white p-2 rounded-md hover:bg-indigo-700">افزودن لینک جدید</button>
    </div>
    <div id="form-modal" class="modal">
        <div class="form-container rounded-xl p-6 shadow-lg max-w-md w-full">
            <h2 id="form-modal-title" class="text-xl font-semibold text-white mb-4">افزودن لینک جدید</h2>
            <div class="space-y-4">
                <input id="link-title" type="text" placeholder="عنوان لینک" maxlength="25" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 text-right">
                <input id="link-url" type="url" placeholder="آدرس لینک (اختیاری)" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 text-right">
                <select id="link-category" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 text-right">
                    <option value="">انتخاب دسته‌بندی</option>
                    <option value="عمومی">عمومی</option>
                    <option value="کاری">کاری</option>
                    <option value="شخصی">شخصی</option>
                </select>
                <input id="new-category" type="text" placeholder="دسته‌بندی جدید (اختیاری)" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 text-right">
                <textarea id="link-notes" placeholder="یادداشت‌ها (اخ اختیاری)" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 text-right h-24"></textarea>
                <div class="flex gap-4">
                    <button id="add-link" class="flex-1 bg-indigo-600 text-white p-2 rounded-md hover:bg-indigo-700">افزودن لینک</button>
                    <button id="cancel-form" class="flex-1 bg-gray-600 text-white p-2 rounded-md hover:bg-gray-700">لغو</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for displaying and editing notes -->
    <div id="notes-modal" class="modal">
        <div class="form-container rounded-xl p-6 shadow-lg max-w-md w-full">
            <h2 id="notes-modal-title" class="text-xl font-semibold text-white mb-4"></h2>
            <textarea id="notes-modal-content" class="notes-display w-full mb-4 p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 text-right" rows="10"></textarea>
            <div class="flex gap-4">
                <button id="save-notes-modal" class="flex-1 bg-indigo-600 text-white p-2 rounded-md hover:bg-indigo-700">ذخیره یادداشت‌ها</button>
                <button id="close-notes-modal" class="flex-1 bg-gray-600 text-white p-2 rounded-md hover:bg-gray-700">بستن</button>
            </div>
        </div>
    </div>

    <!-- New Confirmation Modal -->
    <div id="confirm-modal" class="modal">
        <div class="form-container rounded-xl p-6 shadow-lg max-w-sm w-full text-center">
            <h2 class="text-xl font-semibold text-white mb-4">تایید حذف</h2>
            <p class="text-gray-300 mb-6">آیا مطمئن هستید که می‌خواهید این لینک را حذف کنید؟</p>
            <div class="flex gap-4 justify-center">
                <button id="confirm-delete-btn" class="flex-1 bg-red-600 text-white p-2 rounded-md hover:bg-red-700">حذف</button>
                <button id="cancel-delete-btn" class="flex-1 bg-gray-600 text-white p-2 rounded-md hover:bg-gray-700">لغو</button>
            </div>
        </div>
    </div>

    <div id="loading-spinner" class="text-white text-lg mt-10" style="display: none;">
        در حال بارگذاری...
    </div>

    <div id="link-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 max-w-5xl w-full">
        <!-- Links will be dynamically added here, grouped by category -->
    </div>
    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBDtYnagQJDueVROrE_q9gXuk50IH8flzM",
            authDomain: "linkandnotes.firebaseapp.com",
            projectId: "linkandnotes",
            storageBucket: "linkandnotes.firebasestorage.app",
            messagingSenderId: "211601196274",
            appId: "1:211601196274:web:4660b42dbe23259103bc6b"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let userId = null;
        let links = [];
        let categories = ["عمومی", "کاری", "شخصی"]; // Default categories
        const defaultCategories = ["عمومی", "کاری", "شخصی"]; // For checking if category is default

        // DOM elements
        const linkContainer = document.getElementById('link-container');
        const titleInput = document.getElementById('link-title');
        const urlInput = document.getElementById('link-url');
        const categorySelect = document.getElementById('link-category');
        const newCategoryInput = document.getElementById('new-category');
        const notesInput = document.getElementById('link-notes');
        const addLinkButton = document.getElementById('add-link');
        const showFormButton = document.getElementById('show-form-btn');
        const cancelFormButton = document.getElementById('cancel-form');
        const formModal = document.getElementById('form-modal');
        const formModalTitle = document.getElementById('form-modal-title');
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-btn');

        const notesModal = document.getElementById('notes-modal');
        const notesModalTitle = document.getElementById('notes-modal-title');
        const notesModalContent = document.getElementById('notes-modal-content');
        const closeNotesModalButton = document.getElementById('close-notes-modal');
        const saveNotesModalButton = document.getElementById('save-notes-modal');

        const confirmModal = document.getElementById('confirm-modal');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const userIdDisplay = document.getElementById('user-id-display');
        const loadingSpinner = document.getElementById('loading-spinner');

        let currentLinkDocId = null; // To keep track of the Firestore document ID being edited or deleted
        let isEditMode = false;

        // Show loading spinner
        loadingSpinner.style.display = 'block';

        // Authenticate and set up Firestore listeners
        onAuthStateChanged(auth, async (user) => {
            try {
                if (user) {
                    userId = user.uid;
                } else {
                    // Sign in anonymously if no user is authenticated
                    await signInAnonymously(auth);
                    userId = auth.currentUser.uid;
                }
                userIdDisplay.textContent = `User ID: ${userId}`;
                
                // Set up real-time listeners for links and categories
                setupFirestoreListeners();

            } catch (error) {
                console.error("Authentication error:", error);
                showMessageBox(`خطای احراز هویت: ${error.message}`, 'error');
                userIdDisplay.textContent = `خطا در بارگذاری شناسه کاربری`;
                loadingSpinner.style.display = 'none';
            }
        });

        function setupFirestoreListeners() {
            // Listen for categories
            onSnapshot(collection(db, `users/${userId}/categories`), (snapshot) => {
                const fetchedCategories = snapshot.docs.map(doc => doc.data().name);
                // Merge with default categories to ensure they are always present
                categories = [...new Set([...defaultCategories, ...fetchedCategories])];
                renderCategories();
            }, (error) => {
                console.error("Error fetching categories:", error);
                showMessageBox(`خطا در بارگذاری دسته‌بندی‌ها: ${error.message}`, 'error');
            });

            // Listen for links
            onSnapshot(collection(db, `users/${userId}/links`), (snapshot) => {
                links = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderLinks(searchInput.value);
                loadingSpinner.style.display = 'none'; // Hide spinner once data is loaded
            }, (error) => {
                console.error("Error fetching links:", error);
                showMessageBox(`خطا در بارگذاری لینک‌ها: ${error.message}`, 'error');
                loadingSpinner.style.display = 'none';
            });
        }

        // Render categories in dropdown
        function renderCategories() {
            categorySelect.innerHTML = '<option value="">انتخاب دسته‌بندی</option>';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categorySelect.appendChild(option);
            });
        }

        // Render links grouped by category
        function renderLinks(searchTerm = '') {
            linkContainer.innerHTML = '';
            const filteredLinks = searchTerm
                ? links.filter(link => 
                    link.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    link.url?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    link.notes?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    link.category.toLowerCase().includes(searchTerm.toLowerCase())
                )
                : links;

            categories.forEach(category => {
                const categoryLinks = filteredLinks.filter(link => link.category === category);
                if (categoryLinks.length > 0) {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'flex flex-col gap-4';
                    categoryDiv.innerHTML = `<h2 class="text-2xl font-semibold text-white">${category}</h2>`;
                    categoryLinks.forEach((link) => {
                        const linkElement = document.createElement('div');
                        linkElement.className = 'link-card rounded-lg shadow-md hover:shadow-lg flex justify-between items-start';
                        // Use data attributes to store link data for easy access in event listener
                        linkElement.dataset.id = link.id; // Store Firestore document ID
                        linkElement.dataset.title = link.title;
                        linkElement.dataset.url = link.url || '';
                        linkElement.dataset.notes = link.notes || '';

                        const notesParagraph = link.notes ? `<p class="text-sm notes-text mt-2">${link.notes}</p>` : '';

                        // Truncate title to 25 characters and add ellipsis if longer
                        const displayedTitle = link.title.length > 25 ? link.title.substring(0, 25) + '...' : link.title;

                        const editIconHtml = `
                            <i class="fa-solid fa-pencil edit-icon" data-id="${link.id}"></i>
                        `;

                        linkElement.innerHTML = `
                            <div class="icon-group">
                                <button class="delete-btn text-gray-300 hover:text-red-500" data-id="${link.id}" data-category="${category}">×</button>
                                ${editIconHtml}
                            </div>
                            <div class="flex-1">
                                <a href="${link.url || '#'}" class="block" ${link.url ? 'onclick="event.preventDefault();"' : ''}>
                                    <h3 class="text-lg font-medium text-white">${displayedTitle}</h3>
                                </a>
                                ${notesParagraph}
                            </div>
                        `;
                        categoryDiv.appendChild(linkElement);

                        // Conditionally add scrollable class based on notes length
                        if (link.notes && link.notes.length > 160) {
                            const pElement = linkElement.querySelector('.notes-text');
                            if (pElement) {
                                pElement.classList.add('scrollable');
                            }
                        }
                    });
                    linkContainer.appendChild(categoryDiv);
                }
            });

            // Add event listeners for delete buttons
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const docIdToDelete = e.target.dataset.id;
                    currentLinkDocId = docIdToDelete;
                    confirmModal.classList.add('show');
                });
            });

            // Add event listeners for link cards to show notes modal if no URL
            document.querySelectorAll('.link-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    const url = e.currentTarget.dataset.url;
                    const title = e.currentTarget.dataset.title;
                    const notes = e.currentTarget.dataset.notes;
                    currentLinkDocId = e.currentTarget.dataset.id;

                    if (!url && notes && !e.target.closest('.edit-icon')) {
                        notesModalTitle.textContent = title;
                        notesModalContent.value = notes;
                        notesModal.classList.add('show');
                    } else if (url && !e.target.closest('.edit-icon')) {
                        window.open(url, '_blank');
                    }
                });
            });

            // Add event listeners for edit icons
            document.querySelectorAll('.edit-icon').forEach(icon => {
                icon.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const docId = e.currentTarget.dataset.id;
                    const link = links.find(l => l.id === docId);

                    if (link) {
                        isEditMode = true;
                        currentLinkDocId = docId;

                        formModalTitle.textContent = 'ویرایش لینک';
                        addLinkButton.textContent = 'ذخیره تغییرات';

                        titleInput.value = link.title;
                        urlInput.value = link.url;
                        categorySelect.value = link.category;
                        newCategoryInput.value = '';
                        notesInput.value = link.notes;

                        formModal.classList.add('show');
                    }
                });
            });
        }

        // Add new link or Save edited link
        addLinkButton.addEventListener('click', async () => {
            let title = titleInput.value.trim();
            const url = urlInput.value.trim();
            let category = categorySelect.value;
            const newCategory = newCategoryInput.value.trim();
            const notes = notesInput.value.trim();

            if (title.length > 25) {
                title = title.substring(0, 25);
                showMessageBox('عنوان به 25 کاراکتر محدود شد.', 'info');
            }

            if (!title) {
                showMessageBox('لطفاً عنوان لینک را وارد کنید.', 'error');
                return;
            }

            if (newCategory) {
                category = newCategory;
                // Add new category to Firestore if it doesn't exist
                if (!categories.includes(newCategory)) {
                    try {
                        await addDoc(collection(db, `users/${userId}/categories`), { name: newCategory });
                    } catch (error) {
                        console.error("Error adding new category:", error);
                        showMessageBox(`خطا در افزودن دسته‌بندی جدید: ${error.message}`, 'error');
                    }
                }
            } else if (!category) {
                showMessageBox('لطفاً یک دسته‌بندی انتخاب کنید یا دسته‌بندی جدید وارد کنید.', 'error');
                return;
            }

            try {
                if (isEditMode) {
                    // Update existing link in Firestore
                    await updateDoc(doc(db, `users/${userId}/links`, currentLinkDocId), { title, url, category, notes });
                    showMessageBox('لینک با موفقیت ویرایش شد!', 'success');
                } else {
                    // Add new link to Firestore
                    await addDoc(collection(db, `users/${userId}/links`), { title, url, category, notes });
                    showMessageBox('لینک با موفقیت اضافه شد!', 'success');
                }
            } catch (error) {
                console.error("Error saving link:", error);
                showMessageBox(`خطا در ذخیره لینک: ${error.message}`, 'error');
            }
            
            clearFormAndCloseModal();
        });

        // Show/hide form modal
        showFormButton.addEventListener('click', () => {
            isEditMode = false;
            formModalTitle.textContent = 'افزودن لینک جدید';
            addLinkButton.textContent = 'افزودن لینک';
            clearFormAndCloseModal();
            formModal.classList.add('show');
        });

        cancelFormButton.addEventListener('click', () => {
            clearFormAndCloseModal();
        });

        // Helper function to clear form and close modal
        function clearFormAndCloseModal() {
            titleInput.value = '';
            urlInput.value = '';
            categorySelect.value = '';
            newCategoryInput.value = '';
            notesInput.value = '';
            formModal.classList.remove('show');
        }

        // Close notes modal
        closeNotesModalButton.addEventListener('click', () => {
            notesModal.classList.remove('show');
        });

        // Save notes from modal
        saveNotesModalButton.addEventListener('click', async () => {
            if (currentLinkDocId) {
                try {
                    await updateDoc(doc(db, `users/${userId}/links`, currentLinkDocId), { notes: notesModalContent.value.trim() });
                    notesModal.classList.remove('show');
                    showMessageBox('یادداشت‌ها با موفقیت ذخیره شد!', 'success');
                } catch (error) {
                    console.error("Error saving notes:", error);
                    showMessageBox(`خطا در ذخیره یادداشت‌ها: ${error.message}`, 'error');
                }
            }
        });

        // Confirmation modal buttons
        confirmDeleteBtn.addEventListener('click', async () => {
            if (currentLinkDocId) {
                try {
                    const linkToDelete = links.find(link => link.id === currentLinkDocId);
                    const categoryOfDeletedLink = linkToDelete ? linkToDelete.category : null;

                    await deleteDoc(doc(db, `users/${userId}/links`, currentLinkDocId));

                    // Check if the category is now empty and not a default category
                    if (categoryOfDeletedLink && !defaultCategories.includes(categoryOfDeletedLink)) {
                        const q = query(collection(db, `users/${userId}/links`), where("category", "==", categoryOfDeletedLink));
                        const querySnapshot = await getDocs(q);
                        if (querySnapshot.empty) {
                            // Find the category document and delete it
                            const categoryQuery = query(collection(db, `users/${userId}/categories`), where("name", "==", categoryOfDeletedLink));
                            const categorySnapshot = await getDocs(categoryQuery);
                            if (!categorySnapshot.empty) {
                                await deleteDoc(categorySnapshot.docs[0].ref);
                            }
                        }
                    }

                    confirmModal.classList.remove('show');
                    showMessageBox('لینک با موفقیت حذف شد!', 'success');
                } catch (error) {
                    console.error("Error deleting link:", error);
                    showMessageBox(`خطا در حذف لینک: ${error.message}`, 'error');
                } finally {
                    currentLinkDocId = null; // Reset ID
                }
            }
        });

        cancelDeleteBtn.addEventListener('click', () => {
            confirmModal.classList.remove('show');
            currentLinkDocId = null; // Reset ID
        });

        // Search functionality
        searchInput.addEventListener('input', (e) => {
            renderLinks(e.target.value);
        });

        searchButton.addEventListener('click', () => {
            renderLinks(searchInput.value);
        });

        // Custom Message Box
        function showMessageBox(message, type = 'info') {
            let messageBox = document.getElementById('message-box');
            if (!messageBox) {
                messageBox = document.createElement('div');
                messageBox.id = 'message-box';
                messageBox.className = 'fixed top-4 right-4 p-4 rounded-md shadow-lg text-white z-50';
                document.body.appendChild(messageBox);
            }

            messageBox.textContent = message;
            messageBox.style.display = 'block';

            if (type === 'success') {
                messageBox.style.backgroundColor = '#4CAF50'; // Green
            } else if (type === 'error') {
                messageBox.style.backgroundColor = '#f44336'; // Red
            } else {
                messageBox.style.backgroundColor = '#2196F3'; // Blue (info)
            }

            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 3000); // Hide after 3 seconds
        }
    </script>
    <!-- Custom message box element -->
    <div id="message-box" class="hidden"></div>
</body>
</html>
