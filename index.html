<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لینک‌های مفید من</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome CDN for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Supabase SDK -->
    <!-- The Supabase SDK is loaded here, which makes 'Supabase' available globally -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap');
        body {
            background: linear-gradient(to bottom right, #1e293b, #2d3748);
            min-height: 100vh;
            font-family: 'Vazirmatn', sans-serif;
            color: #e2e8f0;
        }
        .link-card {
            background: #2d3748;
            border: 1px solid #4b5563;
            transition: transform 0.3s ease, box-shadow 0.3s ease, background 0.3s ease;
            cursor: pointer;
            position: relative;
            padding-top: 20px;
            padding-left: 40px;
            padding-right: 24px;
            padding-bottom: 12px;
        }
        .link-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
            background: #3b4a6b;
        }
        .form-container {
            background: #2d3748;
            border: 1px solid #4b5563;
            transition: box-shadow 0.3s ease;
        }
        .form-container:hover {
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }
        input, select, textarea {
            background: #1e293b;
            border: 1px solid #4b5563;
            color: #e2e8f0;
        }
        input:focus, select:focus, textarea:focus {
            border-color: #6366f1;
            outline: none;
            ring: 2px #6366f1;
        }
        button {
            transition: background 0.3s ease;
        }
        button:hover {
            background: #4f46e5;
        }
        .delete-btn {
            transition: color 0.3s ease;
            font-size: 1.5rem;
        }
        .delete-btn:hover {
            color: #ef4444;
        }
        .notes-text {
            color: #94a3b8;
            word-break: break-word;
            overflow-wrap: break-word;
            max-height: 60px;
        }
        .notes-text.scrollable {
            overflow-y: auto;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 50;
            align-items: center;
            justify-content: center;
        }
        .modal.show {
            display: flex;
        }
        .notes-display {
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            background: #1e293b;
            border-radius: 8px;
            color: #e2e8f0;
        }
        #notes-modal .form-container {
            max-width: 600px;
            width: 90%;
        }
        .icon-group {
            position: absolute;
            top: 0px;
            left: 10px;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 5px;
        }
        .edit-icon {
            cursor: pointer;
            color: #94a3b8;
            transition: color 0.3s ease;
        }
        .edit-icon:hover {
            color: #6366f1;
        }
        .link-card h3 {
            word-break: break-word;
            overflow-wrap: break-word;
            overflow: hidden;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center p-6">
    <div class="text-center mb-10">
        <h1 class="text-4xl font-bold text-white">لینک‌های مفید من</h1>
        <p class="text-lg text-gray-300 mt-2">مجموعه‌ای از منابع مورد علاقه من</p>
        <p id="user-id-display" class="text-sm text-gray-400 mt-1">Initializing Supabase...</p>
    </div>
    <div class="max-w-md w-full mb-6 flex gap-2">
        <input id="search-input" type="text" placeholder="جستجوی لینک‌ها..." class="flex-1 p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 text-right bg-[#1e293b] border-[#4b5563]">
        <button id="search-btn" class="bg-indigo-600 text-white p-2 rounded-md hover:bg-indigo-700">جستجو</button>
    </div>
    <div class="max-w-md w-full mb-6">
        <button id="show-form-btn" class="w-full bg-indigo-600 text-white p-2 rounded-md hover:bg-indigo-700">افزودن لینک جدید</button>
    </div>
    <div id="form-modal" class="modal">
        <div class="form-container rounded-xl p-6 shadow-lg max-w-md w-full">
            <h2 id="form-modal-title" class="text-xl font-semibold text-white mb-4">افزودن لینک جدید</h2>
            <div class="space-y-4">
                <input id="link-title" type="text" placeholder="عنوان لینک" maxlength="25" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 text-right">
                <input id="link-url" type="url" placeholder="آدرس لینک (اختیاری)" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 text-right">
                <select id="link-category" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 text-right">
                    <option value="">انتخاب دسته‌بندی</option>
                    <option value="عمومی">عمومی</option>
                    <option value="کاری">کاری</option>
                    <option value="شخصی">شخصی</option>
                </select>
                <input id="new-category" type="text" placeholder="دسته‌بندی جدید (اختیاری)" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 text-right">
                <textarea id="link-notes" placeholder="یادداشت‌ها (اخ اختیاری)" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 text-right h-24"></textarea>
                <div class="flex gap-4">
                    <button id="add-link" class="flex-1 bg-indigo-600 text-white p-2 rounded-md hover:bg-indigo-700">افزودن لینک</button>
                    <button id="cancel-form" class="flex-1 bg-gray-600 text-white p-2 rounded-md hover:bg-gray-700">لغو</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for displaying and editing notes -->
    <div id="notes-modal" class="modal">
        <div class="form-container rounded-xl p-6 shadow-lg max-w-md w-full">
            <h2 id="notes-modal-title" class="text-xl font-semibold text-white mb-4"></h2>
            <textarea id="notes-modal-content" class="notes-display w-full mb-4 p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 text-right" rows="10"></textarea>
            <div class="flex gap-4">
                <button id="save-notes-modal" class="flex-1 bg-indigo-600 text-white p-2 rounded-md hover:bg-indigo-700">ذخیره یادداشت‌ها</button>
                <button id="close-notes-modal" class="flex-1 bg-gray-600 text-white p-2 rounded-md hover:bg-gray-700">بستن</button>
            </div>
        </div>
    </div>

    <!-- New Confirmation Modal -->
    <div id="confirm-modal" class="modal">
        <div class="form-container rounded-xl p-6 shadow-lg max-w-sm w-full text-center">
            <h2 class="text-xl font-semibold text-white mb-4">تایید حذف</h2>
            <p class="text-gray-300 mb-6">آیا مطمئن هستید که می‌خواهید این لینک را حذف کنید؟</p>
            <div class="flex gap-4 justify-center">
                <button id="confirm-delete-btn" class="flex-1 bg-red-600 text-white p-2 rounded-md hover:bg-red-700">حذف</button>
                <button id="cancel-delete-btn" class="flex-1 bg-gray-600 text-white p-2 rounded-md hover:bg-gray-700">لغو</button>
            </div>
        </div>
    </div>

    <div id="link-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 max-w-5xl w-full">
        <!-- Links will be dynamically added here, grouped by category -->
    </div>
    <!-- Custom message box element -->
    <div id="message-box" class="hidden"></div>

    <script type="module">
        // The Supabase SDK is loaded globally via the <script> tag above.
        // We can access its createClient function directly from the global 'Supabase' object.
        const SUPABASE_URL = 'https://qucemgbfrbjckduvutho.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF1Y2VtZ2JmcmJqY2tkdXZ1dGhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI5Mjg4MjcsImV4cCI6MjA2ODUwNDgyN30.cOKm96oCK-L_hSwhuuK3wbrZJ4AbzDHtyKIKaRTd_f4';

        const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        window.currentUserId = null;
        window.links = [];
        window.categories = ["عمومی", "کاری", "شخصی"]; // Default categories
        window.defaultCategories = ["یادداشتها", "عمومی", "کاری", "شخصی"];

        // DOM elements
        const titleInput = document.getElementById('link-title');
        const urlInput = document.getElementById('link-url');
        const categorySelect = document.getElementById('link-category');
        const newCategoryInput = document.getElementById('new-category');
        const notesInput = document.getElementById('link-notes');
        const addLinkButton = document.getElementById('add-link');
        const showFormButton = document.getElementById('show-form-btn');
        const cancelFormButton = document.getElementById('cancel-form');
        const formModal = document.getElementById('form-modal');
        const formModalTitle = document.getElementById('form-modal-title');
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-btn');
        const notesModal = document.getElementById('notes-modal');
        const notesModalContent = document.getElementById('notes-modal-content');
        const closeNotesModalButton = document.getElementById('close-notes-modal');
        const saveNotesModalButton = document.getElementById('save-notes-modal');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const userIdDisplay = document.getElementById('user-id-display');

        let currentLinkToEditId = null;
        let isEditMode = false;
        let currentLinkToDeleteId = null;
        let currentLinkToDeleteCategory = null;

        // --- Supabase Authentication and Data Fetching ---
        async function initializeSupabase() {
            try {
                const { data, error } = await supabase.auth.signInAnonymously();
                if (error) throw error;
                
                window.currentUserId = data.user.id;
                userIdDisplay.textContent = `User ID: ${window.currentUserId}`;
                console.log("Supabase initialized and user signed in anonymously:", window.currentUserId);

                setupSupabaseListeners();
                fetchInitialData(); // Fetch initial data after auth and listeners are set up

            } catch (error) {
                console.error("Error initializing Supabase or signing in:", error.message);
                userIdDisplay.textContent = `Error: ${error.message}`;
                showMessageBox('خطا در اتصال به پایگاه داده.', 'error');
            }
        }

        async function fetchInitialData() {
            // Fetch links
            const { data: linksData, error: linksError } = await supabase
                .from('links')
                .select('*')
                .eq('user_id', window.currentUserId); // Ensure we only fetch user's own links

            if (linksError) {
                console.error("Error fetching initial links:", linksError.message);
                showMessageBox('خطا در بارگذاری لینک‌ها.', 'error');
            } else {
                window.links = linksData;
                window.renderLinks(searchInput.value);
            }

            // Fetch categories
            const { data: categoriesData, error: categoriesError } = await supabase
                .from('categories')
                .select('name')
                .eq('user_id', window.currentUserId); // Ensure we only fetch user's own categories

            if (categoriesError) {
                console.error("Error fetching initial categories:", categoriesError.message);
                showMessageBox('خطا در بارگذاری دسته‌بندی‌ها.', 'error');
            } else {
                const fetchedCategories = categoriesData.map(cat => cat.name);
                window.categories = [...new Set([...window.defaultCategories, ...fetchedCategories])];
                window.renderCategories();
            }
        }

        function setupSupabaseListeners() {
            // Real-time listener for links
            supabase
                .channel('links_changes')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'links', filter: `user_id=eq.${window.currentUserId}` }, payload => {
                    console.log('Link change received!', payload);
                    fetchInitialData(); // Re-fetch all data to ensure consistency and correct sorting
                })
                .subscribe();

            // Real-time listener for categories
            supabase
                .channel('categories_changes')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'categories', filter: `user_id=eq.${window.currentUserId}` }, payload => {
                    console.log('Category change received!', payload);
                    fetchInitialData(); // Re-fetch to update categories dropdown
                })
                .subscribe();
        }

        // --- UI Rendering Functions (mostly unchanged) ---
        window.renderCategories = function() {
            const categorySelect = document.getElementById('link-category');
            categorySelect.innerHTML = '<option value="">انتخاب دسته‌بندی</option>';
            window.categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categorySelect.appendChild(option);
            });
        };

        window.renderLinks = function(searchTerm = '') {
            const linkContainer = document.getElementById('link-container');
            linkContainer.innerHTML = '';
            const filteredLinks = searchTerm
                ? window.links.filter(link => 
                    link.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    link.url?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    link.notes?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    link.category.toLowerCase().includes(searchTerm.toLowerCase())
                )
                : window.links;

            const groupedLinks = filteredLinks.reduce((acc, link) => {
                (acc[link.category] = acc[link.category] || []).push(link);
                return acc;
            }, {});

            const sortedCategories = Object.keys(groupedLinks).sort((a, b) => {
                if (a === "یادداشتها") return -1;
                if (b === "یادداشتها") return 1;
                return a.localeCompare(b);
            });

            sortedCategories.forEach(category => {
                const categoryLinks = groupedLinks[category];
                if (categoryLinks.length > 0) {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'flex flex-col gap-4';
                    categoryDiv.innerHTML = `<h2 class="text-2xl font-semibold text-white">${category}</h2>`;
                    categoryLinks.forEach((link) => {
                        const linkElement = document.createElement('div');
                        linkElement.className = 'link-card rounded-lg shadow-md hover:shadow-lg flex justify-between items-start';
                        linkElement.dataset.id = link.id;
                        linkElement.dataset.title = link.title;
                        linkElement.dataset.url = link.url || '';
                        linkElement.dataset.notes = link.notes || '';
                        linkElement.dataset.category = link.category;

                        const notesParagraph = link.notes ? `<p class="text-sm notes-text mt-2">${link.notes}</p>` : '';
                        const displayedTitle = link.title.length > 25 ? link.title.substring(0, 25) + '...' : link.title;

                        const editIconHtml = `
                            <i class="fa-solid fa-pencil edit-icon" data-id="${link.id}"></i>
                        `;

                        linkElement.innerHTML = `
                            <div class="icon-group">
                                <button class="delete-btn text-gray-300 hover:text-red-500" data-id="${link.id}" data-category="${link.category}">×</button>
                                ${editIconHtml}
                            </div>
                            <div class="flex-1">
                                <a href="${link.url || '#'}" class="block" ${link.url ? 'onclick="event.preventDefault();"' : ''}>
                                    <h3 class="text-lg font-medium text-white">${displayedTitle}</h3>
                                </a>
                                ${notesParagraph}
                            </div>
                        `;
                        categoryDiv.appendChild(linkElement);

                        if (link.notes && link.notes.length > 160) {
                            const pElement = linkElement.querySelector('.notes-text');
                            if (pElement) {
                                pElement.classList.add('scrollable');
                            }
                        }
                    });
                    linkContainer.appendChild(categoryDiv);
                }
            });

            attachEventListeners();
        };

        function attachEventListeners() {
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.onclick = (e) => {
                    e.stopPropagation();
                    currentLinkToDeleteId = e.target.dataset.id;
                    currentLinkToDeleteCategory = e.target.dataset.category;
                    confirmModal.classList.add('show');
                };
            });

            document.querySelectorAll('.link-card').forEach(card => {
                card.onclick = (e) => {
                    if (e.target.closest('.delete-btn') || e.target.closest('.edit-icon')) {
                        return;
                    }

                    const url = e.currentTarget.dataset.url;
                    const title = e.currentTarget.dataset.title;
                    const notes = e.currentTarget.dataset.notes;
                    currentLinkToEditId = e.currentTarget.dataset.id;

                    if (!url && notes) {
                        notesModalTitle.textContent = title;
                        notesModalContent.value = notes;
                        notesModal.classList.add('show');
                    } else if (url) {
                        window.open(url, '_blank');
                    }
                };
            });

            document.querySelectorAll('.edit-icon').forEach(icon => {
                icon.onclick = (e) => {
                    e.stopPropagation();
                    const linkId = e.currentTarget.dataset.id;
                    const link = window.links.find(l => l.id === linkId);

                    if (link) {
                        isEditMode = true;
                        currentLinkToEditId = link.id;

                        formModalTitle.textContent = 'ویرایش لینک';
                        addLinkButton.textContent = 'ذخیره تغییرات';

                        titleInput.value = link.title;
                        urlInput.value = link.url;
                        categorySelect.value = link.category;
                        newCategoryInput.value = '';
                        notesInput.value = link.notes;

                        formModal.classList.add('show');
                    }
                };
            });
        }

        window.showMessageBox = function(message, type = 'info') {
            let messageBox = document.getElementById('message-box');
            if (!messageBox) {
                messageBox = document.createElement('div');
                messageBox.id = 'message-box';
                messageBox.className = 'fixed top-4 right-4 p-4 rounded-md shadow-lg text-white z-50';
                document.body.appendChild(messageBox);
            }

            messageBox.textContent = message;
            messageBox.style.display = 'block';

            if (type === 'success') {
                messageBox.style.backgroundColor = '#4CAF50';
            } else if (type === 'error') {
                messageBox.style.backgroundColor = '#f44336';
            } else {
                messageBox.style.backgroundColor = '#2196F3';
            }

            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 3000);
        };

        // --- Event Listeners for Modals and Forms (Supabase Operations) ---
        document.addEventListener('DOMContentLoaded', () => {
            // Add/Save Link Button
            addLinkButton.addEventListener('click', async () => {
                if (!window.currentUserId) {
                    showMessageBox('Supabase هنوز آماده نیست. لطفاً صبر کنید.', 'error');
                    return;
                }

                let title = titleInput.value.trim();
                const url = urlInput.value.trim();
                let category = categorySelect.value;
                const newCategory = newCategoryInput.value.trim();
                const notes = notesInput.value.trim();

                if (title.length > 25) {
                    title = title.substring(0, 25);
                    showMessageBox('عنوان به 25 کاراکتر محدود شد.', 'info');
                }

                if (!title) {
                    showMessageBox('لطفاً عنوان لینک را وارد کنید.', 'error');
                    return;
                }

                if (newCategory) {
                    category = newCategory;
                    if (!window.categories.includes(newCategory)) {
                        try {
                            const { error } = await supabase
                                .from('categories')
                                .insert({ name: newCategory, user_id: window.currentUserId });
                            if (error) throw error;
                            showMessageBox('دسته‌بندی جدید اضافه شد!', 'success');
                        } catch (e) {
                            console.error("Error adding category:", e.message);
                            showMessageBox('خطا در افزودن دسته‌بندی.', 'error');
                        }
                    }
                } else if (!category) {
                    showMessageBox('لطفاً یک دسته‌بندی انتخاب کنید یا دسته‌بندی جدید وارد کنید.', 'error');
                    return;
                }

                try {
                    if (isEditMode && currentLinkToEditId) {
                        const { error } = await supabase
                            .from('links')
                            .update({ title, url, category, notes })
                            .eq('id', currentLinkToEditId)
                            .eq('user_id', window.currentUserId); // Ensure user owns the link
                        if (error) throw error;
                        showMessageBox('لینک با موفقیت ویرایش شد!', 'success');
                    } else {
                        const { error } = await supabase
                            .from('links')
                            .insert({ title, url, category, notes, user_id: window.currentUserId });
                        if (error) throw error;
                        showMessageBox('لینک با موفقیت اضافه شد!', 'success');
                    }
                } catch (e) {
                    console.error("Error saving link:", e.message);
                    showMessageBox('خطا در ذخیره لینک.', 'error');
                } finally {
                    clearFormAndCloseModal();
                }
            });

            // Show/hide form modal
            showFormButton.addEventListener('click', () => {
                isEditMode = false;
                currentLinkToEditId = null;
                formModalTitle.textContent = 'افزودن لینک جدید';
                addLinkButton.textContent = 'افزودن لینک';
                clearFormAndCloseModal();
                formModal.classList.add('show');
            });

            cancelFormButton.addEventListener('click', () => {
                clearFormAndCloseModal();
            });

            function clearFormAndCloseModal() {
                titleInput.value = '';
                urlInput.value = '';
                categorySelect.value = '';
                newCategoryInput.value = '';
                notesInput.value = '';
                formModal.classList.remove('show');
            });

            // Close notes modal
            closeNotesModalButton.addEventListener('click', () => {
                notesModal.classList.remove('show');
            });

            // Save notes from modal
            saveNotesModalButton.addEventListener('click', async () => {
                if (!window.currentUserId || !currentLinkToEditId) {
                    showMessageBox('Supabase یا لینک برای ویرایش آماده نیست.', 'error');
                    return;
                }
                try {
                    const { error } = await supabase
                        .from('links')
                        .update({ notes: notesModalContent.value.trim() })
                        .eq('id', currentLinkToEditId)
                        .eq('user_id', window.currentUserId); // Ensure user owns the link
                    if (error) throw error;
                    notesModal.classList.remove('show');
                    showMessageBox('یادداشت‌ها با موفقیت ذخیره شد!', 'success');
                } catch (e) {
                    console.error("Error saving notes:", e.message);
                    showMessageBox('خطا در ذخیره یادداشت‌ها.', 'error');
                }
            });

            // Confirmation modal buttons
            confirmDeleteBtn.addEventListener('click', async () => {
                if (!window.currentUserId || !currentLinkToDeleteId) {
                    showMessageBox('Supabase یا لینک برای حذف آماده نیست.', 'error');
                    return;
                }
                try {
                    const { error } = await supabase
                        .from('links')
                        .delete()
                        .eq('id', currentLinkToDeleteId)
                        .eq('user_id', window.currentUserId); // Ensure user owns the link
                    if (error) throw error;
                    showMessageBox('لینک با موفقیت حذف شد!', 'success');
                } catch (e) {
                    console.error("Error deleting link:", e.message);
                    showMessageBox('خطا در حذف لینک.', 'error');
                } finally {
                    confirmModal.classList.remove('show');
                    currentLinkToDeleteId = null;
                    currentLinkToDeleteCategory = null;
                }
            });

            cancelDeleteBtn.addEventListener('click', () => {
                confirmModal.classList.remove('show');
                currentLinkToDeleteId = null;
                currentLinkToDeleteCategory = null;
            });

            // Search functionality
            searchInput.addEventListener('input', (e) => {
                window.renderLinks(e.target.value);
            });

            searchButton.addEventListener('click', () => {
                window.renderLinks(searchInput.value);
            });

            // Initialize Supabase on page load
            initializeSupabase();
        });
    </script>
</body>
</html>
